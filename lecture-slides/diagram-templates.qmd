---
title: "IO Diagrams (TikZ embedded)"
format:
  revealjs:
    slide-number: true
execute:
  echo: false
  warning: false
  message: false
  cache: true
---

```{python}
# | label: tikz-helper
# | include: false

import subprocess
import shutil
from pathlib import Path


def render_tikz_svg(
    tikz_picture: str,
    name: str,
    width: str = "70%",
    engine: str = "pdflatex",
    cleanup: bool = True,
    keep_pdf: bool = False,
) -> str:
    """
    Render TikZ code to SVG via pdflatex + pdftocairo (Positron Cloud compatible).

    Returns: HTML <img> tag for embedding.
    """
    figs_dir = Path("lecture-slides/figs")
    figs_dir.mkdir(parents=True, exist_ok=True)

    tex_file = figs_dir / f"{name}.tex"
    pdf_file = figs_dir / f"{name}.pdf"
    svg_file = figs_dir / f"{name}.svg"

    # Create standalone LaTeX document
    tex_content = f"""\documentclass[tikz,border=2pt]{{standalone}}
\usepackage{{pgfplots}}
\usetikzlibrary{{decorations.pathreplacing}}
\pgfplotsset{{compat=1.18}}
\begin{{document}}
{tikz_picture}
\end{{document}}
"""
    tex_file.write_text(tex_content, encoding="utf-8")

    # Compile to PDF
    if not shutil.which(engine):
        raise RuntimeError(f"LaTeX engine not found: {engine}")

    result = subprocess.run(
        [
            engine,
            "-interaction=nonstopmode",
            f"-output-directory={figs_dir}",
            str(tex_file),
        ],
        capture_output=True,
        text=True,
    )

    if not pdf_file.exists():
        raise RuntimeError(f"PDF not produced.\n{result.stdout}\n{result.stderr}")

    # Convert PDF → SVG using pdftocairo (from poppler-utils)
    if not shutil.which("pdftocairo"):
        raise RuntimeError(
            "pdftocairo not found. Install poppler-utils: "
            "sudo apt-get install poppler-utils (Linux) or brew install poppler (macOS)"
        )

    result = subprocess.run(
        ["pdftocairo", "-svg", str(pdf_file), str(svg_file)],
        capture_output=True,
        text=True,
    )

    if result.returncode != 0:
        raise RuntimeError(f"pdftocairo failed:\n{result.stdout}\n{result.stderr}")

    if not svg_file.exists():
        raise RuntimeError("SVG not produced by pdftocairo.")

    # Cleanup
    if cleanup:
        for ext in [
            ".aux",
            ".log",
            ".out",
            ".synctex.gz",
            ".fls",
            ".fdb_latexmk",
            ".tex",
        ]:
            aux_file = figs_dir / f"{name}{ext}"
            if aux_file.exists():
                aux_file.unlink()

        if not keep_pdf and pdf_file.exists():
            pdf_file.unlink()

    # Return HTML img tag
    from IPython.display import HTML

    return HTML(f'<img src="{svg_file}" style="width:{width}; height:auto;">')
```

```{python}
#| label: fig-hotelling-fixed-location
render_tikz_svg(
    tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round]
\def\xO{0}
\def\xFone{3}
\def\xMC{6}
\def\xFtwo{9}
\def\xL{12}
\draw[thick] (\xO,0) -- (\xL,0);
\fill (\xO,0) circle (2pt);
\fill (\xFone,0) circle (2pt);
\fill (\xMC,0) circle (2pt);
\fill (\xFtwo,0) circle (2pt);
\fill (\xL,0) circle (2pt);
\node[left]  at (\xO,0) {$0$};
\node[right] at (\xL,0) {$L$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xO,0.55) -- (\xFone,0.55) node[midway, yshift=10pt] {$a$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xFone,0.55) -- (\xMC,0.55) node[midway, yshift=10pt] {$x$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xMC,0.55) -- (\xFtwo,0.55) node[midway, yshift=10pt] {$y$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xFtwo,0.55) -- (\xL,0.55) node[midway, yshift=10pt] {$b$};
\node at (\xFone,1.45) {Firm 1};
\draw[->] (\xFone,1.20) -- (\xFone,0.12);
\node at (\xFtwo,1.45) {Firm 2};
\draw[->] (\xFtwo,1.20) -- (\xFtwo,0.12);
\node[align=center] at (\xMC,-1.15) {Marginal\consumer};
\draw[->] (\xMC,-0.75) -- (\xMC,-0.08);
\end{tikzpicture}
""",
    name="fig-hotelling-fixed-location",
    width="70%"
)
```

```{python}
#| label: fig-hotelling-movement-location
render_tikz_svg(
    tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round]
\def\xO{0}
\def\xM{6}   % marginal consumer / co-location point of firms 1 and 2
\def\xL{12}
\draw[thick] (\xO,0) -- (\xL,0);
\fill (\xO,0) circle (2pt);
\fill (\xM,0) circle (2pt);
\fill (\xL,0) circle (2pt);
\node[left]  at (\xO,0) {$0$};
\node[right] at (\xL,0) {$L$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xO,0.55) -- (\xM,0.55) node[midway, yshift=10pt] {$a$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xM,0.55) -- (\xL,0.55) node[midway, yshift=10pt] {$b$};
\node at (\xM,1.45) {Firms 1 and 2};
\draw[->] (\xM,1.20) -- (\xM,0.12);
\node[align=center] at (\xM,-1.15) {Marginal consumer};
\draw[->] (\xM,-0.75) -- (\xM,-0.08);
\end{tikzpicture}
""",
    name="fig-hotelling-movement-location",
    width="70%"
)
```

```{python}
# | label: fig-hotelling-profit-function

render_tikz_svg(
    tikz_picture=r"""
\begin{tikzpicture}
\begin{axis}[
  width=12.8cm, height=6.0cm,
  xmin=0, xmax=10.6,
  ymin=0, ymax=5.2,
  axis lines=left,
  axis line style={thick, -{Stealth[length=2.2mm]}},
  ticks=none,
  clip=false,
  xlabel={$p_1$},
  ylabel={$\pi_1(p_1,\bar p_2)$},
  xlabel style={at={(axis description cs:1.02,0.02)}, anchor=west},
  ylabel style={at={(axis description cs:0.02,1.02)}, anchor=south},
]

% --- Key x locations (chosen to match the screenshot spacing) ---
\pgfmathsetmacro{\xL}{3.25}  % left cutoff: \bar p_2 - c(L-a-b)
\pgfmathsetmacro{\xM}{6.20}  % middle cutoff: \bar p_1
\pgfmathsetmacro{\xR}{8.35}  % right cutoff: \bar p_2 + c(L-a-b)

% --- Key y levels (enforce: yTop > yPeak) ---
\pgfmathsetmacro{\yTop}{4.70}  % highest point (end of linear segment)
\pgfmathsetmacro{\yDrop}{2.55} % value after discrete drop
\pgfmathsetmacro{\yPeak}{3.85} % peak of middle segment (STRICTLY below yTop)

% --- Curvature parameter k from vertex form so that parabola passes through (xL,yDrop) ---
% y(x) = yPeak - k (x-xM)^2, with y(xL)=yDrop => k=(yPeak-yDrop)/(xL-xM)^2
\pgfmathsetmacro{\k}{(\yPeak-\yDrop)/((\xL-\xM)^2)}

% --- Implied right-end y-value (consistent with the same parabola) ---
\pgfmathsetmacro{\yR}{\yPeak - \k*(\xR-\xM)^2}

% 1) Left linear segment (formula): line from (0,0) to (xL,yTop)
\addplot[thick, domain=0:\xL, samples=2] ({x},{(\yTop/\xL)*x});

% 2) Discrete drop at xL
\addplot[thick] coordinates {(\xL,\yTop) (\xL,\yDrop)};

% 3) Middle segment (formula): concave parabola in vertex form
\addplot[thick, domain=\xL:\xR, samples=200] ({x},{\yPeak - \k*(x-\xM)^2});

% --- Dashed vertical cutoffs (match slide: extend to each segment’s value) ---
\addplot[densely dashed, thick, gray] coordinates {(\xL,0) (\xL,\yTop)};
\addplot[densely dashed, thick, gray] coordinates {(\xM,0) (\xM,\yPeak)};
\addplot[densely dashed, thick, gray] coordinates {(\xR,0) (\xR,\yR)};

% --- x-axis labels ---
\node[anchor=north] at (axis cs:\xL,0) {$\bar p_2-c(L-a-b)$};
\node[anchor=north] at (axis cs:\xM,0) {$\bar p_1$};
\node[anchor=north] at (axis cs:\xR,0) {$\bar p_2+c(L-a-b)$};

\end{axis}
\end{tikzpicture}
""",
    name="fig-hotelling-profit-function",
    width="70%",
)
```

```{python}
#| label: fig-salop-cycle

render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[x=1cm,y=1cm, line cap=round, line join=round]
\def\R{2.2} % radius
\draw[thick] (0,0) circle (\R);
\fill (0,\R) circle (1.6pt);
\fill (\R,0) circle (1.6pt);
\fill (0,-\R) circle (1.6pt);
\fill (-\R,0) circle (1.6pt);
\node[above] at (0,\R) {$\bar p$};
\node[right] at (\R,0) {$\bar p$};
\node[below] at (0,-\R) {$p$};
\node[left]  at (-\R,0) {$\bar p$};
\node at (-1.75,  1.75) {$\frac{1}{4}$};
\node at ( 1.75,  1.75) {$\frac{1}{4}$};
\node at (-1.75, -1.75) {$\frac{1}{4}$};
\node at ( 1.75, -1.75) {$\frac{1}{4}$};
\end{tikzpicture}
""",
  name = "fig-salop-cycle",
  width = "70%"
)
```

```{python}
#| label: fig-salop-line
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round]
\def\xL{-4.5}
\def\xC{0}
\def\xR{4.5}
\draw[thick, <->] (-5.5,0) -- (5.5,0);
\fill (\xL,0) circle (2pt);
\fill (\xC,0) circle (2pt);
\fill (\xR,0) circle (2pt);
\node[below] at (\xL,0) {$\bar p$};
\node[below] at (\xC,0) {$p$};
\node[below] at (\xR,0) {$\bar p$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xL,0.6) -- (\xC,0.6)
  node[midway, yshift=10pt] {$\frac{1}{n}$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xC,0.6) -- (\xR,0.6)
  node[midway, yshift=10pt] {$\frac{1}{n}$};
\end{tikzpicture}
""",
  name = "fig-salop-line",
  width = "70%"
)
```

```{python}
#| label: salop-line-mod
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round]
\def\xL{-5.0}   % left \bar p
\def\xA{-2.0}   % left marginal consumer
\def\xC{0.0}    % p (center)
\def\xB{2.0}    % right marginal consumer
\def\xR{5.0}    % right \bar p
\draw[thick, <->] (-6.0,0) -- (6.0,0);
\fill (\xL,0) circle (2pt);
\fill (\xA,0) circle (2pt);
\fill (\xC,0) circle (2pt);
\fill (\xB,0) circle (2pt);
\fill (\xR,0) circle (2pt);
\node[below] at (\xL,0) {$\bar p$};
\node[below] at (\xC,0) {$p$};
\node[below] at (\xR,0) {$\bar p$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xA,0.65) -- (\xC,0.65)
  node[midway, yshift=10pt] {$d_m$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xC,0.65) -- (\xB,0.65)
  node[midway, yshift=10pt] {$d_m$};
\node[align=center] at (\xA,1.55) {Marginal\\consumer};
\draw[->, thick] (\xA,1.20) -- (\xA,0.12);
\node[align=center] at (\xB,1.55) {Marginal\\consumer};
\draw[->, thick] (\xB,1.20) -- (\xB,0.12);
\node[align=center] at (-3.9,0.95) {Net surplus $< 0$};
\draw[->, thick] (-3.2,0.55) -- (-4.9,0.55);
\node[align=center] at (3.9,0.95) {Net surplus $< 0$};
\draw[->, thick] (3.2,0.55) -- (4.9,0.55);
\end{tikzpicture}
""",
  name = "fig-salop-line-mod",
  width = "70%"
)
```

```{python}
#| label: fig-salop-line-comp-region
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round]
\def\xL{-5.0}   % left \bar p
\def\xA{-2.0}   % left marginal consumer
\def\xC{0.0}    % p (center)
\def\xB{2.0}    % right marginal consumer
\def\xR{5.0}    % right \bar p
\draw[thick, <->] (-6.0,0) -- (6.0,0);
\fill (\xL,0) circle (2pt);
\fill (\xA,0) circle (2pt);
\fill (\xC,0) circle (2pt);
\fill (\xB,0) circle (2pt);
\fill (\xR,0) circle (2pt);
\node[below] at (\xL,0) {$\bar p$};
\node[below] at (\xC,0) {$p$};
\node[below] at (\xR,0) {$\bar p$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xL,0.65) -- (\xA,0.65)
  node[midway, yshift=10pt] {$\frac{1}{n}-x$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xA,0.65) -- (\xC,0.65)
  node[midway, yshift=10pt] {$x$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xC,0.65) -- (\xB,0.65)
  node[midway, yshift=10pt] {$x$};
\draw[decorate, decoration={brace, amplitude=4pt}]
  (\xB,0.65) -- (\xR,0.65)
  node[midway, yshift=10pt] {$\frac{1}{n}-x$};
\node[align=center] at (\xA,1.55) {Marginal\\consumer};
\draw[->, thick] (\xA,1.20) -- (\xA,0.12);
\node[align=center] at (\xB,1.55) {Marginal\\consumer};
\draw[->, thick] (\xB,1.20) -- (\xB,0.12);
\end{tikzpicture}
""",
  name = "fig-salop-line-comp-region",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon-2
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon-2",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon-3
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon-3",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon-4
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon-4",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon-5
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon-5",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon-6
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon-6",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon-7
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon-7",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon-8
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon-8",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon-9
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon-9",
  width = "70%"
)
```

```{python}
#| label: fig-salop-demand-comp-mon-10
render_tikz_svg(
  tikz_picture=r"""
\begin{tikzpicture}[>=stealth, line cap=round, line join=round]
\draw[->, thick] (0,0) -- (6.6,0) node[anchor=west] {$q$};
\draw[->, thick] (0,0) -- (0,5.2) node[anchor=south] {$p$};
\fill (0,4.2) circle (1.5pt);
\node[left] at (0,4.2) {$v$};
\draw[thick] (0,4.2) -- (3.0,3.0) -- (5.2,1.6);
\draw[densely dashed, thick] (3.0,0) -- (3.0,4.8);
\node at (3.0,5.1) {$D$};
\node at (5.5,1.6) [anchor=west] {$S$};
\end{tikzpicture}
""",
  name = "fig-salop-demand-comp-mon-10",
  width = "70%"
)
```

